# Sentiment Dashboard

## Ссылка на работающее решение

https://dissolutely-tight-raptor.cloudpub.ru/

В репозитории собран полный пайплайн для быстрой загрузки коллекций отзывов, их автоматической классификации по тональности и визуализации результатов.

## Команда

Data-Heinz

Состав:

Дмитрий Ломакин - презентация, backend, frontend
Дмитрий Смирнов - презентация, frontend
Родионов Георгий - ML, backend
Федорова Виктория - ML

## Структура проекта

```
app/                     ─ сервис FastAPI + SQLAlchemy
└── api/routes.py        ─ публичные эндпоинты (загрузка CSV, отчёты, правки)
└── services/            ─ прикладная логика (files, pipeline, records, evaluation)
└── models.py            ─ ORM‑модели Postgres
sentiment-dashboard-final/ ─ фронтенд на React + Vite
sentiment_model/         ─ артефакты модели (config, веса, tokenizer)
model_service.py         ─ мини‑API, оборачивающее модель в отдельный сервис
docker-compose.yml       ─ окружение API + Postgres + фронт
storage/uploads          ─ сохранённые пользовательские CSV
ml_exploration           ─ весь пусть исследования и работы с моделью машинного обучения, все ноутюуки содержат комментарии и мысли походу ресерча
```

## Как всё работает

1. **Загрузка CSV** (`POST /upload_csv`)
   - Файл сохраняется в `storage/uploads/latest_upload.csv`.
   - `files.save_upload` нормализует данные, задаёт случайное время для строк (в пределах последних 6 месяцев) и создаёт `raw_comments`.
   - `pipeline.process_batch` копирует строки в `cleaned_comments`.
   - `pipeline.run_model` отправляет чистые тексты в сервис модели.

2. **Модель**
   - Код модели находится в `implementation.py`.
   - Запускается отдельным процессом (`uvicorn model_service:app --port 9000`) или на внешнем сервере.
   - URL сервиса задаётся в переменной `MODEL_API_URL` (например, `http://localhost:9000` или внешний HTTPS‑адрес). Рабочий API отправляет туда запросы из `_predict_labels`.

3. **Классификация и отчёты**
   - Предсказанные метки попадают в `classified_comments`.
   - Реализованы вспомогательные запросы: `/sentiment_share`, `/review_series`, `/sentiment_series` (отдаёт временные ряды по positive/negative).
   - Возможна ручная правка (`PUT /classified`) и загрузка эталонной выборки (`POST /upload_labels`) для расчёта F1.

4. **Фронтенд**
   - В `sentiment-dashboard-final/src/services/api.ts` описаны запросы к API.
   - `DashboardPage.tsx` отображает KPI, графики и ленту комментариев.
   - `ChartGrid.tsx` строит три линейных графика (все отзывы, негативные, позитивные) и круговую диаграмму долей. Все графики обновляются после загрузки или ручных правок.

## Основные эндпоинты

| Метод | Путь                 | Назначение                                   |
|-------|----------------------|----------------------------------------------|
| POST  | `/upload_csv`        | Загрузка и автоматическая обработка CSV      |
| GET   | `/review_series`     | Временной ряд всех отзывов                   |
| GET   | `/sentiment_series`  | Временные ряды по негативным/позитивным      |
| GET   | `/sentiment_share`   | Текущие доли тональностей                    |
| GET   | `/classified`        | Просмотр классифицированных комментариев     |
| PUT   | `/classified`        | Ручное изменение типа комментария            |
| GET   | `/export_csv`        | Выгрузка готового CSV                        |
| POST  | `/upload_labels`     | Валидация на эталонной выборке (macro F1)    |

## Подготовка и запуск

### 1. Сервис модели

```bash
pip install -r requirements.txt  # или соответствующий список зависимостей
uvicorn model_service:app --host 0.0.0.0 --port 9000
```

> Если модель вынесена на другой сервер, достаточно запустить там этот процесс и убедиться, что адрес доступен.

### 2. Backend + Postgres (+ Frontend)

```bash
MODEL_API_URL=http://localhost:9000 docker compose up --build
```

Переменную `MODEL_API_URL` можно задать в `.env` или в переменных окружения. При переносе модели на внешний сервер просто измените URL (например, `https://my-ml-server/predict`).

### 3. Фронтенд локально

```bash
cd sentiment-dashboard-final
npm install
npm run dev
```

В `VITE_API_BASE_URL` укажите адрес backend’а (по умолчанию `http://localhost:8000`).

## Работа с системой

1. Загрузите CSV через форму на `/docs` (эндпоинт `/upload_csv`) или через интерфейс фронтенда.
2. Дождитесь автоматической обработки. В интерфейсе появятся:
   - количество загруженных отзывов,
   - три графика (все/негативные/позитивные),
   - доля по тональностям,
   - список комментариев с возможностью поиска и ручной корректировки меток.
3. Для проверки качества загрузите валидационный CSV (`Upload validation CSV`) — F1‑метрика появится в карточке.
4. Готовый результат можно забрать по `/export_csv?file_id=...` или через кнопку Download.

## Полезные заметки

- Загружаемые CSV должны иметь столбец идентификаторов (`id`, `id_message`, `id_comment` и т.п.) и текст (`comment`, `comment_clean`, `text`). При отсутствии даты генератор поставит случайную дату в пределах последних шести месяцев.
- Все пути загрузки/выгрузки настраиваются в `app/config.py` (`upload_dir`, `output_dir`).
- При ручном редактировании комментариев фронт пересчитывает временные ряды и доли, поэтому диаграммы всегда отражают актуальное состояние батча.

Проект таким образом покрывает полный сценарий: от загрузки произвольного CSV с отзывами до автоматической классификации, анализа и экспорта результатов.
